<div class="container-fluid mt-3">
  <div class="row">

    <!-- SIDEBAR: Categories -->
    <div class="col-3 border-end" style="min-height: 80vh;">
      <h5 class="fw-bold mb-3">Categories</h5>

      <ul class="list-group mb-3">
        <li 
          class="list-group-item"
          *ngFor="let cat of categories"
          [class.active]="cat === selectedCategory"
          (click)="onSelectCategory(cat)"
          style="cursor: pointer;">
          {{ cat }}
        </li>
      </ul>

      <!-- Add New Category -->
      <div class="card p-2">
        <label class="form-label mb-1">Add Category</label>
        <input class="form-control form-control-sm mb-2"
               [(ngModel)]="newCategoryName"
               placeholder="e.g. TypeScript">
        <button class="btn btn-sm btn-primary w-100"
                (click)="addCategory()">
          + Add Category
        </button>
      </div>
    </div>

    <!-- RIGHT PANEL: Questions + Recorder -->
    <div class="col-9">

      <h4 class="fw-bold mb-3">
        {{ selectedCategory || 'Select a category' }}
      </h4>

      <!-- Add Question Form -->
      <div class="card mb-3 p-3" *ngIf="selectedCategory">
        <h5 class="mb-3">Add New Question</h5>

        <div class="mb-2">
          <label class="form-label">Topic</label>
          <input class="form-control"
                 [(ngModel)]="newQuestion.topic"
                 placeholder="e.g. let, const, hoisting">
        </div>

        <div class="mb-2">
          <label class="form-label">Question</label>
          <input class="form-control"
                 [(ngModel)]="newQuestion.questionText"
                 placeholder="Write the question">
        </div>

        <div class="mb-2">
          <label class="form-label">Answer (text)</label>
          <textarea rows="4"
                    class="form-control"
                    [(ngModel)]="newQuestion.answerText"
                    placeholder="Write your ideal answer here, including code if needed">
          </textarea>
        </div>

        <button class="btn btn-success"
                (click)="addQuestion()">
          Save Question
        </button>
      </div>

      <!-- Questions Accordion -->
      <div class="accordion" id="questionsAccordion" *ngIf="questions.length">

        <div class="accordion-item mb-2" *ngFor="let q of questions; let i = index">
          <h2 class="accordion-header" [id]="'heading'+i">
            <button class="accordion-button collapsed" type="button"
                    data-bs-toggle="collapse"
                    [attr.data-bs-target]="'#collapse'+i"
                    aria-expanded="false"
                    [attr.aria-controls]="'collapse'+i">
              {{ q.topic }} ‚Äì {{ q.questionText }}
            </button>
          </h2>

          <div [id]="'collapse'+i"
               class="accordion-collapse collapse"
               [attr.aria-labelledby]="'heading'+i"
               data-bs-parent="#questionsAccordion">
            <div class="accordion-body">

              <!-- Question text -->
              <p class="mb-1"><strong>Question:</strong></p>
              <p class="mb-3">{{ q.questionText }}</p>

              <!-- Editable Answer -->
              <label class="form-label">Answer (editable)</label>
              <textarea rows="4"
                        class="form-control mb-3"
                        [(ngModel)]="q.answerText"
                        (blur)="saveAnswer(q)">
              </textarea>

              <!-- Recording Buttons -->
              <div class="mb-3">
                <button class="btn btn-sm btn-outline-primary me-2"
                        (click)="startRecording(q, 'audio')">
                  üé§ Record Audio
                </button>
                <button class="btn btn-sm btn-outline-success me-2"
                        (click)="startRecording(q, 'video')">
                  üé• Record Video
                </button>
                <button class="btn btn-sm btn-outline-dark"
                        (click)="startRecording(q, 'screen')">
                  üñ•Ô∏è Record Screen + Mic
                </button>
              </div>

              <!-- LIVE PREVIEW AREA (video/audio) -->
              <div class="mb-3" *ngIf="currentPreview && currentPreview.questionId === q._id">
                <p class="mb-1">Preview:</p>

                <!-- show audio or video element depending on type -->
                <audio *ngIf="currentPreview.type === 'audio'" controls [src]="currentPreview.url"></audio>
                <video *ngIf="currentPreview.type !== 'audio'" width="320" controls [src]="currentPreview.url"></video>

                <div class="mt-2">
                  <button class="btn btn-sm btn-success me-2"
                          (click)="saveRecording(q)">
                    Save Attempt
                  </button>
                  <button class="btn btn-sm btn-secondary"
                          (click)="cancelPreview()">
                    Cancel
                  </button>
                </div>
              </div>

              <!-- Attempts as small cards -->
              <div class="mt-3">
                <h6>Attempts</h6>
                <div class="row">
                  <div class="col-md-4 mb-2"
                       *ngFor="let a of q.attempts; let idx = index">
                    <div class="card p-2">
                      <small class="text-muted">
                        Attempt #{{ idx + 1 }} ‚Äì {{ a.fileType }}<br>
                        {{ a.date | date:'short' }}
                      </small>

                      <audio *ngIf="a.fileType === 'audio'" controls [src]="a.fileUrl" class="mt-2"></audio>
                      <video *ngIf="a.fileType !== 'audio'" width="100%" controls [src]="a.fileUrl" class="mt-2"></video>

                      <button class="btn btn-sm btn-outline-danger mt-2 w-100"
                              (click)="deleteAttempt(q, a)">
                        Delete Attempt
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <hr>

              <button class="btn btn-sm btn-danger mt-2"
                      (click)="deleteQuestion(q)">
                Delete Question
              </button>

            </div>
          </div>
        </div>

      </div>

      <div *ngIf="selectedCategory && !questions.length" class="alert alert-info mt-3">
        No questions yet. Add your first question above.
      </div>

    </div>
  </div>
</div>
